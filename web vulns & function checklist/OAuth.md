### what & how
*OAuth* is essentially a way for users to grant scope-specific access tokens to service providers through an identity provider
#### **OAuth Overview and Key Concepts**
what about if we have something/interface between the service(images editor) and our data (google images) to handle accessing the data without send our cred to the service⇒ OAuth server
before we explain the OAuth types and there flow we need to explain some concepts:
- **Client application:** The website or web application that wants to access the user's data.
- **Resource owner** : The user whose data the client application wants to access.
- **OAuth service provider:** The website or application that controls the user's data and access to it.
- **OAuth scopes:** which data **Client application** ask to have access to and what kind of operation can perform
    As the name of the scope is just an arbitrary text string, the format can vary dramatically between providers
    the scope name might take any of the following forms depending on the OAuth service being used:
    ```
    scope=contacts
    scope=contacts.read
    scope=contact-list-r
    scope=https://oauth-authorization-server.com/auth/scopes/user/contacts.readonly
    ```
- **`client id`:** A unique identifier assigned to the client application during the registration process with the OAuth service provider. It is used to identify the client when making requests to the authorization server.
- **`client secret`:** A confidential and secure piece of information generated by the authorization server, which only to known the client application and the authorization server. It is used to authenticate the client application during the token request process, providing an additional layer of security.
- **`state`** : Stores a unique, unguessable value that is tied to the current session on the client application. The OAuth service should return this exact value in the response, along with the authorization code. This parameter serves as a form of [[CSRF]] token for the client application by making sure that the request to its `/callback` endpoint is from the same person who initiated the OAuth flow.
- **redirect URI:** `callback` a URI used by OAuth server to send the user authorization code
- **`refresh_token`**: Allows an application to obtain a new `access_token` without prompting the user.
#### **OAuth Flow**
![[Pasted image 20240205171112.png]]
1. The client application requests access to a subset of the user's data, specifying which grant type they want to use and what kind of access they want.
   `identity.com/oauth?client_id=CLIENT_ID response_type=code&state=STATE&redirect_uri=https://example.com/callback&scope=email`
2. The user is prompted to log in to the OAuth service and explicitly give their consent for the requested access.
   `https://example.com/callback?authorization_code=abc123&state=STATE`
3. The client application receives a unique access token that proves they have permission from the user to access the requested data. Exactly how this happens varies significantly depending on the grant type.(in **Authorization code grant type the client app use that token to make server to server connection for get access_token, but in Implicit grant type this token is sent to suitable script to extract the fragment and store it then fetch the user data directly**)
   `identity.com/oauth/token?client_id=CLIENT_ID&client_secret=CLIENT_SECRET&redirect_uri=https://example.com/callback&code=abc123`
4. The client application uses this access token to make API calls fetching the relevant data from the resource server.


### OAuth Checklist
- Code Flaws
	- [ ]  Re-Using the code.
	- [ ]  Code Predict/Bruteforce and Rate-limit?
	- [ ]  Is the code for application X valid for application Y?
- Redirect_uri Flaws
	- [ ]  URL isn't validated at all: `?redirect_uri=https://attacker.com`
	- [ ]  Subdomains allowed (Subdomain Takeover or Open redirect on those subdomains): `?redirect_uri=https://sub.twitterdeck.com`
	- [ ]  Host is validated, path isn't (Chain open redirect): `?redirect_uri=https://twitterdeck.com/callback?redirectUrl=https://evil.com`
	- [ ]  Host is validated, path isn't (Referer leakages): Include external content on HTML page and leak code via `Referer`.
	- [ ]  Weak Regexes:
	```
	?redirect_uri=https://twitterdeck.com.evil.com
	?redirect_uri=https://twitterdeck.com%252eevil.com
	?redirect_uri=https://twitterdeck.com//evil.com/
	?redirect_uri=https://twitterdeck.com%09evil.com
	```
	- [ ]  Bruteforcing the [URL encoded chars](https://pastebin.com/raw/b7HsBvZ7) after host: `?redirect_uri=https://twitterdeck.com§FUZZ§`
	- [ ]  Bruteforcing the [keywords](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/raft-large-words.txt) whitelist after host (or on any whitelist open redirect filter): `?redirect_uri=https://§FUZZ§.com`
		- Imagine "twitter" keyword is allowed so we use: `?redirect_uri=https://eviltwitter.com`
	- [ ]  URI validation in place: use typical open redirect payloads.
- State Flaws
	- [ ]  Missing `State` parameter? (CSRF)
	- [ ]  Predictable `State` parameter?
	- [ ]  Is `State` parameter being verified?
	**What is the CSRF workflow in case of `state` problems?**
	- Attacker generate a valid `authorization_code` link for himself and doesn't use it (doesn't forward the request)
	- Attacker sends the link to the logged-in victim, and if the victim opens the link, attacker's OAuth account will be linked to victim's.
- Evil App
	- [ ]  Race condition when `code` is exchanged for `access_token`
	- [ ]  Race condition when `refresh_token` is exchanged for `access_token`
	- [ ]  If user revocates access, will code be also revocated?
- Misc
	- [ ]  Is `client_secret` validated?
	- [ ]  Are `client_secret`, `access_token`, `refresh_token` leaking somewhere?
	- [ ]  Pre ATO using facebook phone-number signup
		- Register on facebook using a phone-number and it settings add the victim's email address (do not verify it).
		- Use the facebook OAuth on the target website, it might be possible that the application doesn't verify the victim's email.
		- [Reference](https://akshanshjaiswal.medium.com/pre-access-to-victims-account-via-facebook-signup-60219e9e381d)
	- [ ]  No email validation Pre [[Account take over (ATO)]]
		- Register as the victim with his email and your desired password.
		- The victim then tries to login using OAuth such as google or facebook.
		- The application queries the database and respond with: `email already exists.` and links their account to the attackers.
		- If there is no un-link option on the application, the attacker can always login on behalf of the user using OAuth even if they reset password.
- References
	- [HackerScroll](https://github.com/hackerscrolls/SecurityTips/blob/master/MindMaps/OAuth_bugs.png)
	- [The wonderful world of OAuth](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
	- [Pentester.land write ups](https://pentester.land/list-of-bug-bounty-writeups.html)

